set_air_purifier_speed:
  fields:
    percentage:
      description: The percentage that should be set.
      example: "0"
  sequence:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ percentage == 0 }}"
          sequence:
            - service: fan.turn_off
              target:
                entity_id: fan.zhimi_airpurifier_mb3
        - conditions:
            - condition: template
              value_template: "{{ percentage > 0 }}"
          sequence:
            - service: number.set_value
              target:
                entity_id: number.zhimi_airpurifier_mb3_favorite_level
              data:
                value: "{{ ((percentage - (100/15 | round(0))) * 15/100) | round(0)}}"
            - service: fan.set_preset_mode
              target:
                entity_id: fan.zhimi_airpurifier_mb3
              data:
                preset_mode: Favorite
            - service: fan.turn_on
              target:
                entity_id: fan.zhimi_airpurifier_mb3
  mode: single
turn_air_purifier_on:
  sequence:
    - choose:
        - conditions:
            - condition: template
              value_template:
                "{{ state_attr('fan.air_purifier_virtual', 'percentage')
                == 0}}"
          sequence:
            - service: fan.set_percentage
              target:
                entity_id: fan.air_purifier_virtual
              data:
                percentage: 7
        - conditions:
            - condition: template
              value_template:
                "{{ state_attr('fan.air_purifier_virtual', 'percentage')
                > 0 }}"
          sequence:
            - service: fan.set_preset_mode
              target:
                entity_id: fan.zhimi_airpurifier_mb3
              data:
                preset_mode: Favorite
            - service: fan.turn_on
              target:
                entity_id:
                  - fan.zhimi_airpurifier_mb3
              data: {}
  mode: single
